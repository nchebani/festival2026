<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, query, orderBy, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyA4wRPUNY7ELW9sQCMIwWDL0JTt4GhiBMY",
        authDomain: "festival-2026-9821a.firebaseapp.com",
        projectId: "festival-2026-9821a",
        storageBucket: "festival-2026-9821a.firebasestorage.app",
        messagingSenderId: "330460197364",
        appId: "1:330460197364:web:123ad880e38787ce2789a1"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- CORRECTION : RENDRE LES FONCTIONS ACCESSIBLES ---
    window.checkAccess = () => {
        const codeInput = document.getElementById('access-code');
        const code = codeInput.value;
        const error = document.getElementById('login-error');
        
        console.log("Tentative de connexion avec le code:", code); // Pour debug

        if(code === "1234") { 
            document.body.classList.add('is-admin');
            enterApp("ADMINISTRATEUR");
        } else if(code === "0000") {
            document.body.classList.remove('is-admin');
            enterApp("MEMBRE DU GROUPE");
        } else {
            error.classList.remove('hidden');
            codeInput.value = ""; // Vide le champ en cas d'erreur
        }
    };

    function enterApp(role) {
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('app-content').classList.remove('hidden');
        document.getElementById('user-status').innerText = role;
    }

    // --- SYNCHRO FIREBASE ---
    onSnapshot(query(collection(db, "setlist"), orderBy("createdAt")), (s) => {
        const c = document.getElementById('setlist-container'); c.innerHTML = "";
        document.getElementById('stat-songs').innerText = s.size;
        s.forEach(doc => { 
            const track = doc.data();
            c.innerHTML += `<div class="glass p-5 rounded-2xl flex justify-between border-l-2 border-cyan-500">
                <span class="font-bold">${track.name}</span><span class="text-xs text-cyan-500">${track.bpm} BPM</span>
            </div>`;
        });
    });

    onSnapshot(collection(db, "membres"), (s) => {
        const l = document.getElementById('members-list');
        document.getElementById('stat-members').innerText = s.size;
        l.innerHTML = `<h3 class="text-[10px] font-black text-slate-500 uppercase mb-4">L'Ã‰quipe (${s.size})</h3>`;
        s.forEach(doc => {
            const m = doc.data();
            l.innerHTML += `<div class="glass p-4 rounded-xl flex justify-between items-center mb-2">
                <span class="font-bold text-sm">${m.name}</span><span class="text-[9px] bg-cyan-500/10 text-cyan-500 px-2 py-1 rounded uppercase">${m.role}</span>
            </div>`;
        });
    });

    onSnapshot(query(collection(db, "chat"), orderBy("date", "asc")), (s) => {
        const b = document.getElementById('chat-messages'); b.innerHTML = "";
        s.forEach(doc => {
            const m = doc.data();
            b.innerHTML += `<div class="flex flex-col mb-2"><div class="bg-slate-800/60 p-3 rounded-2xl rounded-tl-none text-xs italic border border-white/5">${m.text}</div></div>`;
        });
        b.scrollTop = b.scrollHeight;
    });

    window.dbSendMessage = async () => {
        const i = document.getElementById('chat-input');
        if(i.value) { await addDoc(collection(db, "chat"), { text: i.value, date: serverTimestamp() }); i.value = ""; }
    };
    window.dbAddMember = async () => {
        const n = document.getElementById('mem-name').value;
        const r = document.getElementById('mem-role').value;
        if(n) { await addDoc(collection(db, "membres"), { name: n, role: r }); document.getElementById('mem-name').value = ""; }
    };
    window.addTrackPrompt = async () => {
        const n = prompt("Titre du morceau ?");
        if(n) await addDoc(collection(db, "setlist"), { name: n, bpm: "---", createdAt: serverTimestamp() });
    };
</script>
