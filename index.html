<script type="module">
    // ... (garder le dÃ©but de votre script Firebase)

    // Fonction pour fixer la rÃ©pÃ©tition avec Date et Heure prÃ©cises
    window.fixRepet = async (day) => {
        // 1. On demande l'heure
        const heure = prompt(`Heure de rÃ©pÃ©tition pour le ${day} ? (ex: 19:30)`);
        if(!heure) return;

        // 2. On demande la date prÃ©cise (Calendrier)
        const dateRepet = prompt("Confirme la date prÃ©cise (Format: AAAA-MM-JJ)", new Date().toISOString().split('T')[0]);
        
        if(heure && dateRepet) {
            const fullDate = new Date(`${dateRepet}T${heure.replace('h', ':')}`);
            
            // On met Ã  jour le sondage
            await updateDoc(doc(db, "dispos", "current_week"), { 
                fixedDay: day,
                fixedTime: heure,
                fixedFullDate: dateRepet
            });

            // On crÃ©e automatiquement l'Ã©vÃ©nement dans le planning
            await addDoc(collection(db, "calendar"), { 
                title: `ðŸŽ¸ RÃ©pÃ©tition`, 
                date: dateRepet,
                time: heure,
                timestamp: fullDate.getTime()
            });

            await addDoc(collection(db, "chats"), { 
                txt: `âœ… RÃ‰PÃ‰ FIXÃ‰E : ${day} ${dateRepet.split('-').reverse().join('/')} Ã  ${heure}`, 
                user: "ADMIN", 
                time: serverTimestamp() 
            });
        }
    };

    // 2. LOGIQUE DU TIMER SUR L'ACCUEIL
    onSnapshot(query(collection(db, "calendar"), orderBy("date", "asc")), snap => {
        const list = document.getElementById('list-calendar'); 
        list.innerHTML = "";
        let nextEvent = null;
        const now = Date.now();

        snap.forEach(d => {
            const e = d.data();
            const eventDate = new Date(`${e.date}T${(e.time || "00:00").replace('h', ':')}`);
            
            // Trouver le prochain Ã©vÃ©nement pour le timer
            if (!nextEvent && eventDate.getTime() > now) {
                nextEvent = { ...e, ts: eventDate.getTime() };
            }

            // Affichage dans l'onglet Planning
            const dateObj = new Date(e.date);
            const dateFull = dateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });

            list.innerHTML += `
                <div class="glass p-6 rounded-[2rem] border-l-4 border-cyan-500 mb-4 shadow-xl flex justify-between items-center animate-fade-in">
                    <div>
                        <span class="text-cyan-500 font-black text-[10px] uppercase italic tracking-wider">${dateFull}</span>
                        <h4 class="font-black text-white text-lg uppercase italic">${e.title}</h4>
                        <p class="text-cyan-400/60 text-xs font-bold"><i class="far fa-clock mr-1"></i> ${e.time || "--:--"}</p>
                    </div>
                    <button onclick="window.deleteItem('calendar', '${d.id}')" class="admin-only text-red-500/30 hover:text-red-500 transition-colors"><i class="fas fa-trash"></i></button>
                </div>`;
        });

        // Mise Ã  jour du Timer
        const timerZone = document.getElementById('next-event-timer');
        if (nextEvent) {
            timerZone.classList.remove('hidden');
            updateCountdown(nextEvent.ts, nextEvent.title);
        } else {
            timerZone.classList.add('hidden');
        }
    });

    function updateCountdown(targetTime, title) {
        const interval = setInterval(() => {
            const diff = targetTime - Date.now();
            if (diff <= 0) {
                clearInterval(interval);
                document.getElementById('timer-label').innerText = "C'EST MAINTENANT !";
                return;
            }
            const d = Math.floor(diff / (1000 * 60 * 60 * 24));
            const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            document.getElementById('timer-label').innerText = `PROCHAIN : ${title}`;
            document.getElementById('timer-days').innerText = d.toString().padStart(2, '0');
            document.getElementById('timer-hours').innerText = h.toString().padStart(2, '0');
            document.getElementById('timer-mins').innerText = m.toString().padStart(2, '0');
        }, 1000);
    }
</script>
